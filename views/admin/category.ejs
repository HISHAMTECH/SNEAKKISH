<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Categories</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  
  
  <style>
    body {
      display: flex;
      flex-wrap: wrap;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #343a40;
      color: white;
      height: 100vh;
      padding: 20px;
      position: fixed;
      transition: all 0.3s;
    }

    .sidebar nav {
      display: flex;
      flex-direction: column;
    }

    .sidebar .nav-item {
      color: white;
      text-decoration: none;
      padding: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: 0.3s;
    }

    .sidebar .nav-item:hover,
    .sidebar .nav-item.active {
      background: #007bff;
      border-radius: 5px;
    }

    .content-main {
      margin-left: 270px;
      padding: 20px;
      flex: 1;
      transition: margin-left 0.3s;
    }

    .admin-header {
      background: #343a40;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
    }

    .admin-footer {
      background: #343a40;
      color: white;
      text-align: center;
      padding: 10px;
      margin-top: 20px;
    }

    /* Responsive Design */
    @media (max-width: 991px) {
      .sidebar {
        width: 0;
        padding: 0;
        overflow: hidden;
        position: absolute;
      }

      .sidebar.active {
        width: 250px;
        padding: 20px;
      }

      .content-main {
        margin-left: 0;
      }

      .toggle-sidebar {
        display: block;
        position: fixed;
        top: 15px;
        left: 15px;
        background: #007bff;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
      }
    }

  </style>
</head>
<body>

  <!-- Sidebar Toggle Button -->
  <button class="toggle-sidebar d-lg-none">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <div class="sidebar">
    <nav>
        <a href="/admin/" class="nav-item" data-page="Dashboard">
            <i class="fas fa-chart-line"></i> Dashboard
        </a>
        <a href="/admin/products" class="nav-item" data-page="Products">
            <i class="fas fa-box"></i> Products
        </a>
        <a href="/admin/addProducts" class="nav-item" data-page="Add Products">
            <i class="fas fa-box"></i> Add Products
        </a>
        <a href="#" class="nav-item" data-page="Orders">
            <i class="fas fa-shopping-cart"></i> Orders
        </a>
        <a href="/admin/users" class="nav-item" data-page="Customers">
            <i class="fas fa-users"></i> Customers
        </a>
        <a href="#" class="nav-item" data-page="Reviews">
            <i class="fas fa-star"></i> Reviews
        </a>
        <a href="#" class="nav-item" data-page="Offers">
            <i class="fas fa-gift"></i> Offers
        </a>
        <a href="#" class="nav-item" data-page="Coupon Management">
            <i class="fas fa-ticket-alt"></i> Coupon Management
        </a>
        <a href="#" class="nav-item" data-page="Banner Management">
            <i class="fas fa-image"></i> Banner Management
        </a>
        <a href="/admin/category" class="nav-item active" data-page="Categories">
            <i class="fas fa-list"></i> Categories
        </a>
    </nav>
  </div>

  <div class="content-main">
    <div class="admin-header">
      <h2>Admin Dashboard</h2>
    </div>

    <div class="content-header">
      <h2 class="content-title card-title">Category</h2>
    </div>

    <header class="card-header text-center mb-20">
      <form action="/admin/category/" method="get" class="d-inline w-100">
        <div class="input-group input-group-sm border border-1 border-grey rounded-pill w-100">
          <input type="text" class="form-control border-0 rounded-pill mt-3" placeholder="Search categories" name="search"/>
          <button class="btn btn-primary" type="submit">Search</button>
        </div>
      </form>
    </header>

    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <form method="post" action="/admin/addCategory" onsubmit="return handleFormSubmit(event)">
              <div class="mb-4">
                <label for="product_name" class="form-label">Name</label>
                <input type="text" name="Name" placeholder="Type here" class="form-control" id="Name" required/>
              </div>
              <div class="mb-4">
                <label class="form-label">Description</label>
                <textarea placeholder="Type here" name="Description" class="form-control" id="Description" required></textarea>
              </div>
              <div class="d-grid">
                <button class="btn btn-primary" type="submit">Create category</button>
              </div>
            </form>
          </div>
          <div class="col-md-8">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Offer Price</th>
                    <th>Offer</th>
                    <th>Status</th>
                    <th>List/Unlist</th>
                    <th>Edit</th>
                  </tr>
                </thead>
                <tbody>
                   <%category.reverse().forEach((category,index)=>{%>
                  <tr>
                    <td class="text-start"><%=category.Name%></td>
                    <td class="text-start"><%=category.Description%></td>
                    <td>
                      <%if(category.CategoryOffer){%>
                          <%=category.CategoryOffer%>
                          <%}else{%>
                            0%
                            <%}%>
                    </td>

                  </td>
                  <td class="text-start">
                    <%if(category.CategoryOffer===0){%>
                    <button class="btn btn-info" style="width: 100px">
                      <a href="#" class="text-white" onclick="addOffer('<%=category._id%>')" >Add Offer</a>
                    </button>
                    <%}else{%>
                    <button class="btn btn-info"style="width: 100px">
                      <a href="#" class="text-white" onclick="removeOffer('<%=category._id%>')" >Remove</a>
                    </button>
                    <%}%>
                  </td>
                  <td class="text-start">

                  <%if(category.isListed){%>

                    <span 
                  class="badge rounded-pill alert-danger"
                  style="width:60px; color: green;"
                  >Listed</span
                  >
                 
                  <%}else{%>
                    <span 
                    class="badge rounded-pill alert-success"
                    style="width:60px; color: red;"
                    >Unlisted</span
                    >
                  <%}%>
                </td>

                  <td class="text-start">
                    <%if(category.isListed){%>
                      <button class="btn btn-danger " style="width: 70px;">
                        <a href="/admin/listCategory?id=<%= category._id %>" class="text-white">UnList</a>
                      </button> 
                    <%}else{%>
                      <button class="btn btn-success" style="width: 70px;">
                        <a href="/admin/unListCategory?id=<%= category._id %>" class="text-white">List</a>
                      </button> 
                    <%}%>
                  </td>
                  <td class="text-start">
                    <a href="/admin/editCategory?id=<%= category._id %>" class="btn btn-info text-white">Edit</a>
                  </td>

                  </tr>
                  <%})%>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="pagination-container">
    <% if (currentPage > 1) { %>
    <a href="?page=<%= currentPage - 1 %>">&laquo; Previous</a>
    <% } %> <% for (let i = 1; i <= totalPage; i++) { %> <% if (i ===
    currentPage) { %>
    <span class="current-page"><%= i %></span>
    <% } else { %>
    <a href="?page=<%= i %>"><%= i %></a>
    <% } %> <% } %> <% if (currentPage < totalPage) { %>
    <a href="?page=<%= currentPage + 1 %>">Next &raquo;</a>
    <% } %>
  </div>


  <script>
    document.querySelector(".toggle-sidebar").addEventListener("click", function () {
    document.querySelector(".sidebar").classList.toggle("active");
});

function handleFormSubmit(event) {
    event.preventDefault();
    
    if (!validateForm()) {
        return;
    }

    const Name = document.getElementById("Name").value.trim();
    const Description = document.getElementById("Description").value.trim();

    fetch('/admin/addCategory', {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ Name, Description })
    })
    .then((response) => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error);
            });
        }
        return response.json();
    })
    .then((data) => {
        location.reload();
    })
    .catch((error) => {
        if (error.message.toLowerCase().includes("category already exist")) {
            Swal.fire({
                icon: 'error',
                title: "Oops",
                text: "Category Already Exists"
            });
        } else {
            Swal.fire({
                icon: "error",
                title: "Oops",
                text: "An error occurred while adding the category."
            });
        }
    });
}

function validateForm() {
    clearErrorMessage();
    const Name = document.getElementById("Name").value.trim();
    const Description = document.getElementById("Description").value.trim();
    let isValid = true;

    if (Name === "") {
        displayErrorMessage("Name-error", "Please enter a name.");
        isValid = false;
    } else if (!/^[a-zA-Z\s]+$/.test(Name)) {
        displayErrorMessage("Name-error", "Category name should contain only alphabetic characters.");
        isValid = false;
    }

    if (Description === "") {
        displayErrorMessage("Description-error", "Please enter a description.");
        isValid = false;
    }

    return isValid;
}

function displayErrorMessage(elementId, message) {
    let errorElement = document.getElementById(elementId);
    if (!errorElement) {
        errorElement = document.createElement("div");
        errorElement.id = elementId;
        errorElement.className = "error-message text-danger mt-1";
        const inputField = document.getElementById(elementId.replace("-error", ""));
        inputField.parentNode.appendChild(errorElement);
    }
    errorElement.innerText = message;
    errorElement.style.display = "block";
}

function clearErrorMessage() {
    const errorElements = document.getElementsByClassName("error-message");
    Array.from(errorElements).forEach((element) => {
        element.innerText = "";
        element.style.display = "none";
    });
}



 async function addOffer(categoryId){

  const {value:amount}= await Swal.fire({
    title:"Offer In Percentage",
    input:"number",
    inputLabel:"Percentage",
    inputPlaceholder:"%"
  })

  if(amount){
    try {
      const responce =await fetch("/admin/addCategoryOffer",{
        method:"POST",
        headers:{
          "Content-Type": "application/json",
        },
        body:JSON.stringify({
          percentage:amount,
          categoryId:categoryId
        })
      })

      const data= await responce.json();
      if(responce.ok && data.status===true ){
        Swal.fire(
          "Offer Added",
          "The Offer Has Been Added",
          "success"
        ).then(()=>{
          location.reload()
        })
      }else{
        swal.fire("Failed",data.message || "Adding Offer Failed","error")
      } 

    } catch (error) {
      Swal.fire(
        "Error",
        "Error Occured While Adding The Offer",
        "error"
      )
      console.log("Error Adding Offer",error);
      
    }
  }

 }


async function removeOffer(categoryId) {
  try {
    const responce =await fetch('/admin/removeCategoryOffer',{
      method:'POST',
      headers:{
        "Content-Type": "application/json"
      },
      body:JSON.stringify({
        categoryId:categoryId,
      })
    })

    const data= await responce.json();
  if(responce.ok && data.status===true){
    Swal.fire(
      "Offer Removed",
      "Offer Has Been Removed",
      "Success"
    ).then(()=>{
      location.reload()
    })
  }else{
    Swal.fire("Failed",data.message || "Removing Ofer Failed","error")
  }

  } catch (error) {
    Swal.fire(
        "Error",
        "Error Occured While Removing The Offer",
        "error"
      )
      console.log("Error Removing Offer",error);
      
  }
  
}



  </script>

</body>
</html>
